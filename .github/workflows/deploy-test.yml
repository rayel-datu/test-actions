name: Deploy Test

on:
  push:
    branches:
      - feature/* # Only trigger when commits are pushed

jobs:
  deploy-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for actual commits
        run: |
          COMMIT_COUNT=$(git rev-list --count --first-parent origin/${{ github.ref_name }})
          echo $COMMIT_COUNT
          if [ "$COMMIT_COUNT" -eq 1 ]; then
            echo "Initial branch push detectedâ€”skipping deployment."
            echo "SKIP_DEPLOYMENT=true" >> $GITHUB_ENV
          fi

      - name: Extract Version from pubspec.yaml
        run: |
          if [[ "$SKIP_DEPLOYMENT" == "true" ]]; then
            echo "Skipping checkout step."
            exit 0
          fi
            VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
            echo "VERSION=$VERSION" >> $GITHUB_ENV  # Stores version in environment

      - name: Identify triggering branch
        run: |
          if [[ "$SKIP_DEPLOYMENT" == "true" ]]; then
            echo "Skipping this step."
            exit 0
          fi
          CURRENT_BRANCH=$(echo $GITHUB_REF | sed -E 's|refs/heads/||')
          echo "CURRENT_BRANCH=$CURRENT_BRANCH" >> $GITHUB_ENV

      - name: Checkout triggering branch
        run: |
          if [[ "$SKIP_DEPLOYMENT" == "true" ]]; then
            echo "Skipping this step."
            exit 0
          fi
          git checkout $CURRENT_BRANCH

      - name: Create and switch to release-test branch
        run: |
          if [[ "$SKIP_DEPLOYMENT" == "true" ]]; then
            echo "Skipping this step."
            exit 0
          fi
          git tag release-test/$VERSION
          git push origin release-test/$VERSION

      - name: Deploy release-test
        run: |
          if [[ "$SKIP_DEPLOYMENT" == "true" ]]; then
            echo "Skipping this step."
            exit 0
          fi
          echo "Deploying release-test/$VERSION..."
          # Add deployment steps here
